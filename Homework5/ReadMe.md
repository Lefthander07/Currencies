<p align="center">
  <img src="/assets/logo.png" alt="logo" title="backend интенсив fuse8"/>
</p>

# Задание к уроку 5
Для данного задания вам понадобится база данных PostgreSQL <br />
Можно скачать и установить standalone-версию PostgreSQL с [официального сайта](https://www.postgresql.org/download/)

Но мы рекомендуем развернуть PostgreSQL в docker-е <br />
Для этого необходимо сделать следующее
- Скачать и установить [Docker Desktop](https://www.docker.com/products/docker-desktop/)
- Сохранить в своем репозитории файл [docker-compose.yml](docker-compose.yml)
- Открыть консоль в директории, где лежит `docker-compose.yml`
- Выполнить следующую команду в консоле для скачивания образа PostgreSQL
```shell
docker compose -f docker-compose.yml pull
```
- После скачивания образа, выполнить следующую команду для сборки контейнера с PostgreSQL
```shell
docker compose -f docker-compose.yml up -d
```
- База данных будет доступна по порту 5432
- Авторизационные данные указаны в [docker-compose.yml](docker-compose.yml) При желании можете их изменить
  - login =`someUser`
  - password=`P@ssw0rd`


# Доработки в проекте InternalApi
## Добавить Базу данных
- Добавить и настроить `DbContext`
- Установить схему для `DbContext` - `cur`
- Создать пустую инициальную миграцию

## Переделать кэширующий сервис на использование базы данных
- Добавить таблицы, для хранения кэша `ICachedCurrencyAPI` 
- Дополнительно на свое усмотрение вы можете добавить индексы и ограничения к созданным таблицам
- Переделать сервис `ICachedCurrencyAPI` на использование базы данных
  - вместо сохранения на диск, сохранять в БД
  - вместо чтения с диска, получать данные из БД

## Доработать gRPC-сервис
Базовая валюта, относительно которой будет рассчитываться курс, будет приходить из PublicApi, поэтому необходимо доработать proto-файл и сервер следующим образом
- В методах получения курса валют дополнительно принимать валюту, относительно которой необходимо вычислить курс
- Из респонса метода получения настроек убрать базовую валюту

## Доработать процесс кэширования

Т.к. InternalApi больше не управляет базовой валютой, относительно которой считается курс, то необходимо доработать процесс кэширования <br />
Можно сделать разделение кэша относительно базовой валюты, дополнительно хранить базовый курс в БД и для каждого нового базового курса делать новый запрос к внешнему API <br />
Но таким образом, очень быстро можно израсходовать лимит запросов  <br />

Так что лучше хранить кэш только для одной валюты, а при запросе делать преобразование по следующему алгоритму:
- `REQ_CUR` - валюта, для которой необходимо вычислить курс
- `REQ_CUR_BASE` - базовая валюта, относительно которой необходимо вычислить курс
- `CACHE_BASE` - базовая валюта, относительно которой строится кэш
- *Рекомендуем хранить `CACHE_BASE` в виде константы в коде. Т.к. если она неявно изменится в конфигурации, кэш станет невалидным*
0. Обновить кэш если он протух либо нет данных по алгоритму из ДЗ4
1. Получить курс для валюты `REQ_CUR` относительно базовой валюты `CACHE_BASE` из кэша 
2. Если `CACHE_BASE` равен `REQ_CUR_BASE` - вернуть полученный курс
3. Получить курс для валюты `REQ_CUR_BASE` относительно базовой валюты `CACHE_BASE` из кэша 
4. Вычислить результат по следующей формуле: { курс для REQ_CUR } / { курс для REQ_CUR_BASE }

Пример: <br />
Получаем курс рубля относительно евро. <br />
Базовая валюта, относительно которой строится кэш - доллар <br />
- `REQ_CUR` = `RUB`
- `REQ_CUR_BASE` = `EUR`
- `CACHE_BASE` = `USD`
0. Проверяем что кэш не протух, при необходимости запрашиваем актуальный курс для всех валют относительно `USD`
1. Получаем из кэша курс для `RUB` относительно `USD` = `95.9903962843`
2. `USD` не равно `EUR`, поэтому идем дальше
3. Получаем из кэша курс для `EUR` относительно `USD` = `0.9165901128` 
4. Вычисляем курс рубля относительно евро = `95.9903962843 / 0.9165901128 = 104.725541923` 

Получение курса на определенную дату будет аналогичным <br />
Пример: <br />
Получаем курс рубля относительно евро на `17 июня 2024`. <br />
Базовая валюта, относительно которой строится кэш - доллар <br />
- `REQ_CUR` = `RUB`
- `REQ_CUR_BASE` = `EUR`
- `CACHE_BASE` = `USD`
0. Проверяем, есть ли в кэше данные за `17 июня 2024`. Если нет, то запрашиваем курс для всех валют на `17 июня 2024` относительно `USD` 
1. Получаем из кэша курс для `RUB` относительно `USD` = `89.0658962843`
2. `USD` не равно `EUR`, поэтому идем дальше
3. Получаем из кэша курс для `EUR` относительно `USD` = `0.9165901128` 
4. Вычисляем курс рубля относительно евро = `89.0658962843 / 0.93604357941 = 95.1514419237` 

# Доработки в проекте PublicApi
## Добавить Базу данных
- Добавить и настроить `DbContext`
- Установить схему для `DbContext` - `user`
- Создать пустую инициальную миграцию

## Добавить функциональность для сохранения Избранных курсов валют
### Добавить таблицу для хранения Избранных курсов валют
- Добавить таблицу со следующими полями:
  - Идентификатор
  - Название
  - Тип валюты, для которой считается курс 
  - Базовая валюта, относительно которой считается курс

- Настроить таблицу Избранных курсов валют следующим образом:
  - Название должно быть уникальным
  - В таблице не может быть двух записей с одинаковыми валютой и базовой валютой. <br />
    Т.е. если в таблице есть запись `("RubToEuro", "RUB", "EUR")`, нельзя добавить `("AnotherName", "RUB", "EUR")`
  - Дополнительно на свое усмотрение вы можете добавить индексы и ограничения к созданным таблицам

### Добавить API для CRUD операций над Избранными курсами валют
- Получить Избранное по его названию
- Получить список всех Избранных
- Добавить новое Избранное. 
  - Явно проверять что данные из запроса удовлетворяют ограничениям, которые наложены на таблицу в бд (уникальность имени, уникальность валют)
- Изменить Избранное по его названию. 
  - Явно проверять что данные из запроса удовлетворяют ограничениям, которые наложены на таблицу в бд (уникальность имени, уникальность валют)
- Удалить Избранное по его названию

### Добавить методы API для получения курсов для Избранных валют
- Получить *текущий* курс для Избранной валюты по её названию
  - Метод должен вызывать `grpc-сервис` с Типом валюты и Базовым курсом из БД
- Получить курс для Избранного по его названию *на конкретную дату*
  - Метод должен вызывать `grpc-сервис` с Типом валюты и Базовым курсом из БД и датой из запроса
