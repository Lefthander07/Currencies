<p align="center">
  <img src="/assets/logo.png" alt="logo" title="backend интенсив fuse8"/>
</p>

# Задание к уроку 3
Если вы пропустили выполнение первых заданий, то перед тем как приступить к заданию, убедитесь, что в корне вашего репозитория есть файл `.gitignore` настроенный на исключения файлов c#<br />
Если его нет, скопируйте [.gitignore](/.gitignore) из корня данного репозитория в корень своего репозитория <br />
Про `.gitignore` рекомендуем почитать [данную статью](https://ru.hexlet.io/courses/intro_to_git/lessons/gitignore/theory_unit)

С данного задания начинается реализация вашего pet-проекта
- Создайте в корне своего репозитория папку `CurrencyApi` и перенесите в нее содержимой из [CurrencyApi](CurrencyApi)
- Закоммитьте это в `main` (**Самостоятельно**. Не нужно для этого создавать PR и ждать апрува от нас)
- От этого коммита начните ветку для выполнения данного домашнего задания

# Описание pet-проекта
API для отслеживания курсов валют <br />
API будет реализовано на основе [внешнего API](https://currencyapi.com/docs/quickstart) с добавлением функциональности, которая в этом API отсутствует <br />
Для того, чтобы получить доступ к API необходимо зарегистрироваться на сайте, предоставляющем API https://app.currencyapi.com/register


# Настроить проект PublicApi
- Настроить логирование входящих запросов через middleware (логировать те параметры, которые считаете нужными)
- При реализации своего API нужно добавить описание для следующих компонентов (см. пример в [HealthCheckController.cs](CurrencyApi%2FPublicApi%2FControllers%2FHealthCheckController.cs)):
  - Описание контроллера
  - Описание методов контроллера
  - Описание всех входных параметров метода контроллера
  - Описание всех возможных кодов ответа у метода контроллера
  - Описание для моделей, которые используются в качестве возвращаемого значения у методов контроллера
  - Описание свойств моделей 
- Настроить Swagger. В проекте уже добавлена регистрация сваггера с использованием библиотеки `Swashbuckle`, заменять библиотеку на другую не разрешается <br />
Необходимо доработать регистрацию, чтобы сваггер отображал комментарии у контроллеров, методов контроллеров и у моделей


# Реализовать API отправки запросов к внешнему API 
Реализовать свой API на основе https://currencyapi.com/docs/quickstart <br />

## Получить доступ к внешнему API
- Перейдите на страницу https://app.currencyapi.com/api-keys и сохраните `API Key`
- Чтобы исключить попадание ключа в репозиторий, храните `API Key` в файле настроек `appsettings.Development.json`. **Добавьте этот файл в `.gitignore`**
- При создании проекта в своем репозитории *убедитесь что изменения в `appsettings.Development.json` не попадают в репозиторий*

## Реализовать сервис для отправки запросов к API курсов валют
- Использовать готовое SDK **не разрешается**
- Для реализации запросов к внешнему API необходимо использовать `HttpClient`
- Должно быть реализовано логирование запросов к внешнему API через `HttpClient`. Используйте для этого библиотеку `Audit.Net` <br />
  Необходимо логировать боди и хедеры запроса, боди и хедеры ответа, а также хедеры контента
- `API Key` для авторизации запросов должен браться из конфигурации приложения (при изменении значения в конфигурации, должно автоматически обновляться)
- У внешнего API **есть ограничение на количество запросов = 300 запросов в месяц**. <br />
  Поэтому перед отправкой запросов следует проверить сколько запросов еще доступно. <br />
  Нужно создать своё исключение `ApiRequestLimitException`. И, если все доступные запросы исчерпаны, выбросить исключение `ApiRequestLimitException` <br />
  Проверить количество оставшихся запросов можно вызвав метод внешнего API https://api.currencyapi.com/v3/status согласно [документации](https://currencyapi.com/docs/status)
  _Вызов этого метода не уменьшает количество оставшихся запросов_
- **Если во время тестирования у вас закончатся запросы, придется регистрировать новый аккаунт на другую почту**
- При попытке выполнения запроса с неизвестной валютой, внешний API возвращает ошибку с `StatusCode=UnprocessableEntity(422)` и следующим телом
```
{
    "message": "Validation error",
    "errors": {
        "currencies": [
            "The selected currencies is invalid."
        ]
    },
    "info": "For more information, see documentation: https://currencyapi.com/docs/status-codes#_422"
}
```
Нужно создать своё исключение `CurrencyNotFoundException`. И при получении такого сообщения от внешнего API выбрасывать исключение `CurrencyNotFoundException`

## Обработка исключений
- Реализовать обработчик исключений `IExceptionFilter` и зарегистрировать его глобально для всех запросов PublicApi
  - При возникновении исключения `ApiRequestLimitException` логировать ошибку и возвращать `StatusCode=TooManyRequests(429)`
  - При возникновении исключения `CurrencyNotFoundException` НЕ логировать ошибку и возвращать `StatusCode=NotFound(404)`
  - При возникновении любого другого исключения логировать ошибку, возвращать `StatusCode=InternalServerError(500)`

# Добавить необходимы контроллеры для реализации следующего API 
Для отправки запросов к внешнему API, использовать сервис описанный выше
## GET /currency 
- Должен вызывать метод внешнего API `https://api.currencyapi.com/v3/latest?currencies=RUB&base_currency=USD` согласно [документации](https://currencyapi.com/docs/latest)
- Должен возвращаться курс валюты по умолчанию
- Курс валют по умолчанию `RUB` необходимо брать из конфигурации приложения (при изменении значения в конфигурации, должно автоматически обновляться)  
- Базовую валюту `USD` необходимо брать из конфигурации приложения (при изменении значения в конфигурации, должно автоматически обновляться)
- Курс должен округляться до двух знаков после запятой. Количество знаков следует брать из конфигурации приложения (при изменении значения в конфигурации, должно автоматически обновляться)
- Должен возвращать JSON вида 

```
{
  "code": "RUB", // код валюты
  "value": 90.50 // текущий курс относительно доллара
}
```

### GET /currency/{currencyCode}
- Должен вызывать метод внешнего API `https://api.currencyapi.com/v3/latest?currencies={currencyCode}&base_currency=USD` согласно [документации](https://currencyapi.com/docs/latest)
- Должен возвращать текущий курс валюты, переданной в качестве параметра
- Базовую валюту `USD` необходимо брать из конфигурации приложения (при изменении значения в конфигурации, должно автоматически обновляться)
- Курс должен округляться до двух знаков после запятой. Количество знаков следует брать из конфигурации приложения (при изменении значения в конфигурации, должно автоматически обновляться)
- Должен возвращать JSON вида

```
{
  "code": "RUB", // код валюты
  "value": 90.50 // текущий курс относительно доллара
}
```

### GET /currency/{currencyCode}/{date}
- {date} должна иметь формат `yyyy-MM-dd`
- Должен вызывать метод внешнего API `https://api.currencyapi.com/v3/historical?currencies={currencyCode}&date={date}&base_currency=USD`  согласно [документации](https://currencyapi.com/docs/historical)
- Должен возвращать курс валюты, переданной в качестве параметра, на определенную дата
- Базовую валюту `USD` необходимо брать из конфигурации приложения (при изменении значения в конфигурации, должно автоматически обновляться)
- Курс должен округляться до двух знаков после запятой. Количество знаков следует брать из конфигурации приложения (при изменении значения в конфигурации, должно автоматически обновляться)
- Должен возвращать JSON вида (дата должна иметь формат `yyyy-MM-dd`)

```
{
  "date": "2020-12-25", // дата актуальности курса
  "code": "RUB", // код валюты
  "value": 90.50 // текущий курс относительно доллара
}
```

### GET /settings
- Должен возвращать текущие настройки приложения
  - Основные настройки должны браться из конфигурации приложения (при изменении значений в конфигурации, должны автоматически обновляться)
  - Информация о количестве доступных запросов должна получаться от внешнего API https://api.currencyapi.com/v3/status согласно [документации](https://currencyapi.com/docs/status)
- Должен возвращать JSON вида 

```
{
  "defaultCurrency": "RUB", // текущий курс валют по умолчанию из конфигурации
  "baseCurrency": "USD", // базовая валюта, относительно которой считается курс
  "requestLimit": 300, // общее количество доступных запросов, полученное от внешнего API (quotas->month->total)
  "requestCount": 0, //  количество использованных запросов, полученное от внешнего API (quotas->month->used)
  "currencyRoundCount": 2 // Количество знаков после запятой, до которого следует округлять значение курса валют
}
```